- [1. Docker Volume là gì?](#1-docker-volume-là-gì)
- [2. Phân tích các trường hợp và cách sử dụng](#2-phân-tích-các-trường-hợp-và-cách-sử-dụng)
  - [2.1 Cách sử dụng volumes](#21-cách-sử-dụng-volumes)
  - [2.2 Trường hợp nào thì sử dụng bind mounts](#22-trường-hợp-nào-thì-sử-dụng-bind-mounts)
  - [2.3 Trường hợp nào thì sử dụng tmpfs mount](#23-trường-hợp-nào-thì-sử-dụng-tmpfs-mount)
- [3. Cách sử dụng](#3-cách-sử-dụng)
  - [3.1 Cách sử dụng volumes](#31-cách-sử-dụng-volumes)
  - [3.2 Cách sử dụng bind mounts](#32-cách-sử-dụng-bind-mounts)
  - [3.3 Cách sử dụng tmpfs mounts](#33-cách-sử-dụng-tmpfs-mounts)
- [Tài liệu tham khảo](#tài-liệu-tham-khảo)
# 1. Docker Volume là gì?
- Docker Volume là một cơ chế để quản lý dữ liệu trong các container Docker. Khi bạn chạy một container, dữ liệu có thể được lưu trữ trong hệ thống file bên trong container đó. Tuy nhiên, khi container bị xóa hoặc tạo lại, dữ liệu này sẽ bị mất. Để giải quyết vấn đề này, Docker cung cấp volumes.
- Docker cung cấp 3 cách khác nhau để có thể chia sẻ dữ liệu (mount data) từ Docker host tới container đó là:
    - volumes
    - bind mounts
    - tmpfs mounts
  
![alt text](anh/Screenshot_26.png)

- Hình ảnh trên mô tả vị trí lưu trữ dữ liệu của container trên Docker host. Theo đó, ta có thể thấy được:
  - volumes được lưu trữ như một phần của filesystem trên Docker host và được quản lý bởi Docker (xuất hiện trong /var/lib/docker/volumes trên Linux). Đây được xem là cách tốt nhất để duy trì dữ liệu trong Docker
  - bind mounts cho phép lưu trữ bất cứ đâu trong host system.
  - tmpfs mounts cho phép lưu trữ tạm thời dữ liệu vào bộ nhớ của Docker host, không bao giờ ghi vào filesystem của Docker host.
# 2. Phân tích các trường hợp và cách sử dụng
## 2.1 Cách sử dụng volumes
- volumes được tạo và quản lý bởi Docker. Ta có thể tạo volumes với câu lệnh docker volume create hoặc tạo volumes trong khi tạo containers, ...

- Khi tạo ra volumes, nó sẽ được lưu trữ trong một thư mục trên Docker host. Khi ta thực hiện mount volumes vào container thì thư mục này sẽ được mount vào container. Điều này tương tự như cách bind mounts hoạt động ngoại trừ việc được Docker quản lý.

- volumes có thể được mount vào nhiểu containers cùng một lúc. Khi không có containers nào sử dụng volumes thì volumes vẫn ở trạng thái cho phép mount vào containers và không bị xóa một cách tự động.

- volumes hỗ trợ volume drivers, do đó ta có thể sử dụng để lưu trữ dữ liệu từ remote hosts hoặc cloud providers.
- Đây là cách phổ biến được lựa chọn để duy trì dữ liệu trong services và containers. Một số trường hợp sử dụng volumes có thể bao gồm:
  - Chia sẻ dữ liệu giữa nhiều containers: Ví dụ container chứa sql cần phải chia sẻ với nhiều container web khác
  - Dữ liệu cần tồn tại khi dừng hoặc xóa containers: Bạn có một cơ sở dữ liệu hoặc một ứng dụng lưu trữ dữ liệu quan trọng cần duy trì, ngay cả khi container chạy ứng dụng bị dừng hoặc bị xóa.
  - Docker host có cấu trúc filesystem không ổn định: như việc nâng cấp hệ điều hành, thay đổi ổ cứng, hoặc các yêu cầu di chuyển hệ thống.
  - Lưu trữ dữ liệu containers trên remote hosts hoặc cloud: Khi bạn muốn chia sẻ cho nhiều docker server khác
  - Khi có nhu cầu sao lưu, backup hoặc migrate dữ liệu tới Docker host khác thì volumes là một sự lựa tốt. Ta cần phải dừng containers sử dụng volumes sau đó thực hiện backup tại đường dẫn `/var/lib/docker/volumes/<volume-name>`
## 2.2 Trường hợp nào thì sử dụng bind mounts
Bind mounts thường được sử dụng trong các trường hợp sau:
- Chia sẻ các file cấu hình từ Docker host tới containers: Bạn có một file cấu hình Nginx trên Docker host ở đường dẫn `/etc/nginx/nginx.conf`. Bạn muốn sử dụng cấu hình này cho container Nginx
- Chia sẻ file hoặc cấu trúc thư mục cố định: container nginx cần ghi log trục tiếp vào file `/var/log/`
## 2.3 Trường hợp nào thì sử dụng tmpfs mount
`tmpfs mounts` được sử dụng trong các trường hợp ta không muốn dữ liệu tồn tại trên Docker host hay containers vì lý do bảo mật hoặc đảm bảo hiệu suất của containers khi ghi một lượng lớn dữ liệu một cách không liên tục.

Nếu bạn có một container cần xử lý thông tin đăng nhập tạm thời mà bạn không muốn lưu lại trên Docker host, bạn có thể sử dụng tmpfs mount

# 3. Cách sử dụng
## 3.1 Cách sử dụng volumes
- Để tạo một volume, ta sử dụng câu lệnh:
  ```
  docker volume create my-vol
  ```
- Khi khởi chạy containers với volume chưa có (tồn tại) thì Docker sẽ tự động tạo ra volume với tên được khai báo hoặc với một tên ngẫu nhiên và đảm bảo tên ngẫu nhiên này là duy nhất. Ví dụ:
  ```
  docker run -d \
    -it \
    --name devtest \
    --mount type=volume,source=myvol2,target=/var/www/html \
    nginx:latest
  ```
  câu lệnh trên sẽ thực hiện mount volume `myvol2` tới thư mục `/home/thanhquang` trong container `devtest`
- Nếu muốn mount volume với chế độ readonly, ta có thể thêm vào trong --mount. Với ví dụ trên có thể là làm như sau:
  ```
  --mount source=myvol2,target=/app,readonly
  ```
## 3.2 Cách sử dụng bind mounts
- Sử dụng tương tự như volume, ta chỉ cần thay đổi giá trị của type trong --mount. Theo đó ta có câu lệnh ví dụ như sau:
  ```
  docker run -d \
    -it \
    --name devtest \
    --mount type=bind,source=myvol2,target=/var/www/html \
    nginx:latest
  ```
## 3.3 Cách sử dụng tmpfs mounts
- Khi sử dụng tmpfs mounts thì ta không thể chia sẻ dữ liệu giữa containers.
- tmpfs mounts chỉ làm việc đối với Linux containers.
- Tương tự như khi sử dụng volumes, ta chỉ cần thay đổi giá trị type trong --mount:
  ```
  docker run -d \
    -it \
    --name devtest \
    --mount type=tmpfs,source=myvol2,target=/var/www/html \
    nginx:latest
  ```
# Tài liệu tham khảo
https://github.com/hocchudong/ghichep-docker/blob/master/docs/docker-coban/docker-volume.md